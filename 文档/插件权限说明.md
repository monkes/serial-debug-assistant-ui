# 插件权限问题解决方案

## 问题描述

在安装deb包后，用户尝试复制插件文件到系统插件目录 `/usr/lib/debug-assistant/plugins/` 时遇到权限错误：
```
[Errno 13] 权限不够: '/usr/lib/debug-assistant/plugins/serial_debug.py'
```

## 原因分析

系统插件目录 `/usr/lib/debug-assistant/plugins/` 由root用户所有，普通用户没有写权限。这是Linux系统的安全机制，防止普通用户修改系统文件。

## 解决方案

我们采用了双插件目录策略，同时支持系统插件和用户插件：

### 1. 系统插件目录
- 路径：`/usr/lib/debug-assistant/plugins/`
- 用途：存放系统预装的插件
- 权限：只读（普通用户）
- 管理：由deb包维护者管理

### 2. 用户插件目录
- 路径：`~/.local/share/debug-assistant/plugins/`
- 用途：存放用户自定义插件
- 权限：读写（用户可完全控制）
- 管理：由用户自行管理

## 实现细节

### PluginManager 改进

```python
class PluginManager:
    def __init__(self):
        # 系统插件目录
        # 如果在开发环境中运行，使用项目目录中的插件目录
        # 否则使用安装后的插件目录
        if os.path.exists(os.path.join(os.path.dirname(os.path.abspath(__file__)), 'plugins')):
            self.system_plugin_dir = os.path.join(os.path.dirname(os.path.abspath(__file__)), 'plugins')
        else:
            self.system_plugin_dir = '/usr/lib/debug-assistant/plugins'
        # 用户插件目录
        self.user_plugin_dir = os.path.expanduser(
            '~/.local/share/debug-assistant/plugins'
        )

        # 确保用户插件目录存在
        os.makedirs(self.user_plugin_dir, exist_ok=True)
```

### 加载插件顺序

1. 先加载系统插件
2. 再加载用户插件
3. 用户插件会覆盖同名的系统插件

```python
def load_all_plugins(self):
    all_plugins = {}

    # 先加载系统插件
    system_plugins = self.load_plugins_from_dir(self.system_plugin_dir)
    all_plugins.update(system_plugins)

    # 再加载用户插件（会覆盖同名的系统插件）
    user_plugins = self.load_plugins_from_dir(self.user_plugin_dir)
    all_plugins.update(user_plugins)

    return all_plugins
```

### 插件管理改进

1. **加载插件**：新插件会被复制到用户插件目录
2. **删除插件**：优先从用户目录删除，如果不存在则尝试从系统目录删除
3. **插件列表**：显示所有已加载的插件（系统+用户）

## 使用方法

### 添加新插件

1. 在应用程序中选择"插件 > 加载插件..."
2. 选择插件文件
3. 插件会自动复制到用户插件目录
4. 无需root权限

### 删除插件

1. 在插件管理面板中选择要删除的插件
2. 点击"移除插件"按钮
3. 插件文件会从用户目录或系统目录中删除

## 优势

1. **安全性**：用户无法意外修改系统插件
2. **灵活性**：用户可以自由添加和管理自己的插件
3. **可维护性**：系统更新不会影响用户插件
4. **兼容性**：符合Linux文件系统层次结构标准（FHS）

## 注意事项

1. 用户插件目录会在首次运行时自动创建
2. 如果需要修改系统插件，需要使用sudo权限
3. 升级deb包时，系统插件可能会被更新，但用户插件不受影响
4. 用户插件会覆盖同名的系统插件
